<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Used Phone Resale Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .inventory-table-row {
            cursor: pointer;
        }
        .inventory-table-row:hover {
            background-color: #f9fafb;
        }
        .inventory-table-row.selected {
            background-color: #eef2ff;
            --tw-ring-color: #4f46e5;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }
        /* Custom Modal Styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Used Phone Resale Dashboard</h1>
                    <p class="text-gray-600 mt-2">AI-powered tools for optimizing your used phone business.</p>
                </div>
                <div id="datetime-container" class="text-right">
                    <p class="text-lg font-semibold text-gray-800" id="current-time"></p>
                    <p class="text-sm text-gray-500" id="current-date"></p>
                </div>
            </div>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6 overflow-x-auto" id="tabs">
                <button data-tab="appraisal" class="tab-button active py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none flex-shrink-0">
                    Appraisal & Purchase
                </button>
                <button data-tab="inventory" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none flex-shrink-0">
                    Inventory
                </button>
                 <button data-tab="history" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none flex-shrink-0">
                    Transaction History
                </button>
                 <button data-tab="recommendations" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none flex-shrink-0">
                    Accessory Cross-Sell
                </button>
                <button data-tab="discontinuation" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none flex-shrink-0">
                    Discontinuation Alerts
                </button>
            </nav>
        </div>

        <main id="tab-content">
            <div id="appraisal-content" class="tab-pane active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-4">Appraise a Phone</h2>
                        <form id="appraisal-form" class="space-y-4">
                            <div>
                                <label for="appraisal-model" class="block text-sm font-medium text-gray-700">Phone Model</label>
                                <select id="appraisal-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                     <option value="">Select a Model</option>
                                </select>
                            </div>
                            <div>
                                <label for="appraisal-grade" class="block text-sm font-medium text-gray-700">Condition Grade</label>
                                <select id="appraisal-grade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option>A</option>
                                    <option>B</option>
                                    <option>C</option>
                                    <option>D</option>
                                </select>
                            </div>
                             <div>
                                <label for="desired-profit" class="block text-sm font-medium text-gray-700">Desired Profit ($)</label>
                                <input type="number" id="desired-profit" value="25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Appraise
                            </button>
                        </form>
                    </div>
                    <div class="md:col-span-2 space-y-6">
                        <div id="appraisal-results-container" class="bg-white p-6 rounded-xl shadow-sm hidden">
                            <h2 class="text-xl font-semibold mb-4">Appraisal Results</h2>
                             <div id="appraisal-loader" class="flex justify-center items-center h-48 hidden">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                            </div>
                            <div id="appraisal-results" class="space-y-4"></div>
                        </div>
                         <div id="purchase-section" class="bg-white p-6 rounded-xl shadow-sm hidden">
                            <h2 class="text-xl font-semibold mb-2">Finalize Purchase</h2>
                            <div id="purchase-summary" class="mb-4 p-3 bg-gray-50 rounded-md border"></div>
                            <form id="purchase-form" class="space-y-4">
                                <div>
                                    <label for="purchase-store" class="block text-sm font-medium text-gray-700">Store</label>
                                    <select id="purchase-store" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                         <option value="">Select a Store</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="purchase-price" class="block text-sm font-medium text-gray-700">Final Purchase Price ($)</label>
                                    <input type="number" step="0.01" id="purchase-price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter final price...">
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Finalize Purchase
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="inventory-content" class="tab-pane hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-4">Combined Inventory by Store</h2>
                        <p class="text-sm text-gray-500 mb-4">Click an item to see its details.</p>
                        <div id="inventory-accordion-loader" class="flex justify-center items-center h-64">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                        </div>
                        <div id="inventory-accordion-container" class="space-y-2">
                        </div>
                    </div>
                    <div id="inventory-results-container" class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-4">Item Details</h2>
                         <div id="inventory-loader" class="flex justify-center items-center h-48 hidden">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                        </div>
                        <div id="inventory-results-placeholder" class="text-center text-gray-500 pt-16">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No Item Selected</h3>
                            <p class="mt-1 text-sm text-gray-500">Select an item from the inventory list to see its details.</p>
                        </div>
                        <div id="phone-details-view" class="space-y-4 hidden"></div>
                        <div id="accessory-details-view" class="space-y-4 hidden"></div>
                    </div>
                </div>
            </div>

            <div id="history-content" class="tab-pane hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h2 class="text-xl font-semibold mb-4">Transaction History & Analysis</h2>
                    <form id="history-filter-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                        <div>
                            <label for="history-model" class="block text-sm font-medium text-gray-700">Phone Model</label>
                            <select id="history-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="">All Models</option>
                            </select>
                        </div>
                        <div>
                            <label for="history-grade" class="block text-sm font-medium text-gray-700">Grade</label>
                            <select id="history-grade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="">All Grades</option>
                                <option>A</option><option>B</option><option>C</option><option>D</option>
                            </select>
                        </div>
                        <div>
                            <label for="history-store" class="block text-sm font-medium text-gray-700">Store</label>
                            <select id="history-store" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="">All Stores</option>
                            </select>
                        </div>
                        <div>
                            <label for="history-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="history-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="history-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="history-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Apply</button>
                    </form>
                </div>

                <div id="history-loader" class="flex justify-center items-center h-64 hidden">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                </div>
                <div id="history-results-area" class="hidden space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Total Revenue</p><p id="summary-revenue" class="text-2xl font-semibold"></p></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Total COGS</p><p id="summary-cost" class="text-2xl font-semibold"></p></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Total Profit</p><p id="summary-profit" class="text-2xl font-semibold"></p></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Items Sold</p><p id="summary-items" class="text-2xl font-semibold"></p></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Avg. Days in Stock</p><p id="summary-avg-days" class="text-2xl font-semibold"></p></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                             <h3 class="text-lg font-semibold mb-4 text-center">Monthly Profit</h3>
                             <div class="h-80 relative">
                                <canvas id="history-chart"></canvas>
                             </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                             <h3 class="text-lg font-semibold mb-4">Transactions</h3>
                             <div class="overflow-auto h-96">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0"><tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">TXN ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Model</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Grade</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Sale Price</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Profit/Loss</th>
                                    </tr></thead>
                                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="recommendations-content" class="tab-pane hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-4">Accessory Recommendations</h2>
                        <form id="recommendation-form" class="space-y-4">
                            <div>
                                <label for="recommendation-model" class="block text-sm font-medium text-gray-700">Phone Model</label>
                                <select id="recommendation-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Get Recommendations
                            </button>
                        </form>
                    </div>
                    <div id="recommendation-results-container" class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm hidden">
                        <h2 class="text-xl font-semibold mb-4">Top 3 Recommended Accessories</h2>
                        <div id="recommendation-loader" class="flex justify-center items-center h-48 hidden">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                        </div>
                        <div id="recommendation-results" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <div id="discontinuation-content" class="tab-pane hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">Accessory Discontinuation Alerts</h2>
                    <p class="mb-4 text-gray-600">These accessories are compatible with phone models that have had very low sales in the past 180 days. Consider liquidating this stock.</p>
                    <div id="discontinuation-loader" class="flex justify-center items-center h-48 hidden">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                    </div>
                    <div id="discontinuation-table-container" class="overflow-x-auto hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Accessory Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount of Sales Last 30d</th>
                                </tr>
                            </thead>
                            <tbody id="discontinuation-list" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="custom-modal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="modal-container relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                     <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title">Success</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message">
                        Your action was successful.
                    </p>
                </div>
                <div class="items-center px-4 py-3" id="modal-buttons">
                    </div>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        let historyChartInstance = null;
        let currentPurchaseInfo = {};

        // --- Helper Functions ---
        const showLoader = (loaderId) => document.getElementById(loaderId).classList.remove('hidden');
        const hideLoader = (loaderId) => document.getElementById(loaderId).classList.add('hidden');
        
        async function apiFetch(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    } else {
                        throw new Error(`Server returned an unreadable error: ${response.status} ${response.statusText}`);
                    }
                }
                const text = await response.text();
                return text ? JSON.parse(text) : {};
            } catch (error) {
                console.error(`Fetch error for ${endpoint}:`, error);
                throw error;
            }
        }

        // --- Custom Modal Logic ---
        function showModal({ title, message, confirmText, cancelText, onConfirm, iconType = 'success' }) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; // Use innerHTML to allow for formatted messages
            const buttonsDiv = document.getElementById('modal-buttons');
            buttonsDiv.innerHTML = ''; // Clear previous buttons

            const iconDiv = document.getElementById('modal-icon');
            if (iconType === 'success') {
                iconDiv.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
                iconDiv.innerHTML = '<svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else if (iconType === 'warning') {
                iconDiv.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100';
                iconDiv.innerHTML = '<svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
            } else { // error
                 iconDiv.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
                 iconDiv.innerHTML = '<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            }

            if (onConfirm) { // This means it's a confirmation dialog
                const confirmBtn = document.createElement('button');
                confirmBtn.className = "px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300";
                confirmBtn.textContent = confirmText || 'Confirm';
                confirmBtn.onclick = () => {
                    onConfirm();
                    modal.classList.add('hidden');
                };
                buttonsDiv.appendChild(confirmBtn);
            }

            const closeBtn = document.createElement('button');
            closeBtn.className = "px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300 ml-2";
            closeBtn.textContent = cancelText || 'Close';
            closeBtn.onclick = () => modal.classList.add('hidden');
            buttonsDiv.appendChild(closeBtn);
            
            modal.classList.remove('hidden');
        }


        // --- Live Clock ---
        function updateClock() {
            const now = new Date();
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            
            if(timeEl && dateEl) {
                timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        // --- Tab Switching Logic ---
        document.getElementById('tabs').addEventListener('click', (e) => {
            if (e.target.matches('button')) {
                const tab = e.target.dataset.tab;
                switchTab(tab);
            }
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            const activeTabButton = document.querySelector(`[data-tab="${tabId}"]`)
            if(activeTabButton){
                activeTabButton.classList.add('active');
            }

            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');

             if (tabId === 'appraisal') {
                document.getElementById('appraisal-results-container').classList.add('hidden');
                document.getElementById('purchase-section').classList.add('hidden');
            }
            
            if (tabId === 'inventory' && !document.getElementById('inventory-accordion-container').innerHTML.trim()) {
                loadCombinedInventory();
            } else if (tabId === 'history' && !document.getElementById('history-table-body').innerHTML.trim()) {
                loadTransactionHistory();
            }
        }

        // --- Populate Phone Models ---
        async function populatePhoneModels() {
            try {
                const models = await apiFetch('/products');
                const selects = [
                    document.getElementById('appraisal-model'),
                    document.getElementById('recommendation-model'),
                    document.getElementById('history-model')
                ];
                
                selects.forEach(select => {
                    if (select) {
                        const firstOption = select.options[0] ? select.options[0].outerHTML : '';
                        select.innerHTML = firstOption;
                        models.forEach(model => {
                            select.innerHTML += `<option>${model}</option>`;
                        });
                    }
                });

            } catch (error) {
                 console.error("Failed to populate phone models", error);
                 document.getElementById('appraisal-model').innerHTML = '<option>Error loading</option>';
            }
        }
        
        async function populateStores() {
            try {
                const stores = await apiFetch('/stores');
                const selects = [
                    document.getElementById('history-store'),
                    document.getElementById('purchase-store')
                ];
                selects.forEach(select => {
                    if(select) {
                        const firstOption = select.options[0] ? select.options[0].outerHTML : '';
                        select.innerHTML = firstOption;
                        stores.forEach(store => {
                            select.innerHTML += `<option value="${store.store_id}">${store.store_name}</option>`;
                        });
                    }
                });
            } catch (error) {
                console.error("Failed to populate stores", error);
                 document.getElementById('history-store').innerHTML = '<option>Error loading</option>';
            }
        }

        // --- Appraisal & Purchase Logic ---
        document.getElementById('appraisal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const model = document.getElementById('appraisal-model').value;
            const grade = document.getElementById('appraisal-grade').value;
            const desiredProfit = document.getElementById('desired-profit').value;
            const resultsContainer = document.getElementById('appraisal-results-container');
            const purchaseSection = document.getElementById('purchase-section');
            const resultsDiv = document.getElementById('appraisal-results');

            if (!model) {
                showModal({ title: 'Input Error', message: 'Please select a phone model to appraise.', cancelText: 'OK', iconType: 'warning' });
                return;
            }
            
            showLoader('appraisal-loader');
            resultsContainer.classList.remove('hidden');
            purchaseSection.classList.add('hidden'); 
            resultsDiv.innerHTML = '';

            try {
                const data = await apiFetch('/appraise/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_name: model, grade: grade, desired_profit: desiredProfit })
                });

                currentPurchaseInfo = {
                    model_name: data.model_appraised,
                    grade: data.grade
                };
                
                const velocityColor = data.predicted_sales_velocity === 'Fast Mover' ? 'text-green-600' : 
                                    data.predicted_sales_velocity === 'Medium Mover' ? 'text-yellow-600' : 'text-red-600';
                
                let marketAlertHtml = '';
                if (data.market_alert) {
                    marketAlertHtml = `<div class="p-4 border-l-4 border-yellow-400 bg-yellow-50"><div class="flex"><div class="flex-shrink-0"><svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.026 2.287-1.026 2.923 0l5.613 9.043c.642 1.033-.173 2.358-1.462 2.358H4.105c-1.289 0-2.104-1.325-1.462-2.358l5.614-9.043zM10 12a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></div><div class="ml-3"><p class="text-sm text-yellow-700">Market Shift Alert: Your historical buy price for this model is higher than the current market can support for a profit. Proceed with caution.</p></div></div></div>`;
                }

                resultsDiv.innerHTML = `<div class="space-y-6"><div><p class="text-sm text-gray-500">Model Appraised</p><p class="text-lg font-semibold">${data.model_appraised} (Grade: ${data.grade})</p></div>${marketAlertHtml}<div class="p-4 border-2 border-green-500 rounded-lg bg-green-50"><p class="text-sm font-medium text-green-800 text-center">Primary Recommendation: Target Buy Price</p><p class="text-center text-sm text-gray-600 mt-1">To make a <span class="font-bold">$${desiredProfit}</span> profit, you should offer:</p><p class="text-4xl font-bold text-center my-2 text-green-600">$${data.profit_targeted_buy_price_range.low.toFixed(2)} - $${data.profit_targeted_buy_price_range.high.toFixed(2)}</p><p class="text-xs text-center text-gray-500">(Median Target: $${data.profit_targeted_buy_price_range.median.toFixed(2)})</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t"><div class="p-3 border rounded-lg"><p class="text-sm font-medium text-gray-700">Historically-Based Buy Price</p><p class="text-sm text-gray-500 mb-1">(What you've paid in the past)</p><p class="text-lg font-semibold text-indigo-600">$${data.historically_based_buy_price.low.toFixed(2)} - $${data.historically_based_buy_price.high.toFixed(2)}</p><p class="text-sm text-gray-500">Median: $${data.historically_based_buy_price.median.toFixed(2)}</p></div><div class="p-3 border rounded-lg"><p class="text-sm font-medium text-gray-700">Predicted Sales Velocity</p><p class="text-lg font-semibold ${velocityColor}">${data.predicted_sales_velocity}</p><p class="text-xs text-gray-500 mt-1">${data.velocity_reason || ''}</p></div></div></div>`;
                
                // Show purchase section and pre-fill data
                purchaseSection.classList.remove('hidden');
                document.getElementById('purchase-summary').innerHTML = `You are about to purchase a <strong>Grade ${data.grade} ${data.model_appraised}</strong>.`;
                document.getElementById('purchase-price').value = data.profit_targeted_buy_price_range.median.toFixed(2);
                
            } catch (error) {
                 showModal({ title: 'Appraisal Failed', message: error.message, cancelText: 'OK', iconType: 'error' });
            } finally {
                hideLoader('appraisal-loader');
            }
        });
        
        document.getElementById('purchase-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const storeId = document.getElementById('purchase-store').value;
            const price = document.getElementById('purchase-price').value;
            
            if (!storeId || !price) {
                 showModal({ title: 'Input Error', message: 'Please select a Store and enter a Final Purchase Price.', cancelText: 'OK', iconType: 'warning' });
                return;
            }

            const storeName = document.getElementById('purchase-store').options[document.getElementById('purchase-store').selectedIndex].text;

            showModal({
                title: 'Confirm Purchase',
                message: `Are you sure you want to purchase a <strong>Grade ${currentPurchaseInfo.grade} ${currentPurchaseInfo.model_name}</strong> for <strong>$${price}</strong> at <strong>${storeName}</strong>?`,
                confirmText: 'Yes, Purchase',
                cancelText: 'Cancel',
                iconType: 'warning',
                onConfirm: async () => {
                    try {
                        const response = await apiFetch('/inventory/buy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...currentPurchaseInfo,
                                store_id: storeId,
                                acquisition_price: price
                            })
                        });
                        showModal({
                            title: 'Purchase Successful!',
                            message: `A new inventory unit has been created with Unit ID: <strong>${response.unit_id}</strong>`,
                            cancelText: 'OK',
                            iconType: 'success'
                        });
                        
                        // Reset forms and hide results/purchase sections
                        document.getElementById('appraisal-form').reset();
                        document.getElementById('purchase-form').reset();
                        document.getElementById('appraisal-results-container').classList.add('hidden');
                        document.getElementById('purchase-section').classList.add('hidden');
                         // Force a refresh of inventory data so the new item appears on next view
                        document.getElementById('inventory-accordion-container').innerHTML = '';
                    } catch (error) {
                        showModal({ title: 'Purchase Failed', message: error.message, cancelText: 'OK', iconType: 'error' });
                    }
                }
            });
        });


        // --- Combined Inventory Logic ---
        async function loadCombinedInventory() {
            const accordionContainer = document.getElementById('inventory-accordion-container');
            showLoader('inventory-accordion-loader');
            accordionContainer.innerHTML = '';

            const label_styles = {
                'Fast Mover': 'bg-green-100 text-green-800',
                'Medium Mover': 'bg-yellow-100 text-yellow-800',
                'Dead Stock': 'bg-red-100 text-red-800',
                'Discontinuation Alert': 'bg-orange-100 text-orange-800'
            };

            try {
                const data = await apiFetch('/inventory/combined');
                
                if (Object.keys(data).length === 0) {
                    accordionContainer.innerHTML = '<p class="text-gray-500">No in-stock inventory found.</p>';
                    return;
                }

                const sortedStoreNames = Object.keys(data).sort();
                let accordionHtml = '';
                for (const storeName of sortedStoreNames) {
                    const storeData = data[storeName];
                    const summary = storeData.summary;
                    
                    let phoneTableRows = '';
                    if (summary.phone_units > 0) {
                        storeData.phones.sort((a, b) => a.model_name.localeCompare(b.model_name));
                        storeData.phones.forEach(item => {
                            const labelClass = label_styles[item.velocity_label] || 'bg-gray-100 text-gray-800';
                            const label = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${labelClass}">${item.velocity_label}</span>`;
                            phoneTableRows += `<tr class="inventory-table-row" data-item-type="phone" data-unit-id="${item.unit_id}"><td class="px-4 py-3 text-sm text-gray-600">${item.model_name}</td><td class="px-4 py-3 text-sm font-medium text-gray-900 text-center">${item.unit_id}</td><td class="px-4 py-3 text-sm text-gray-600 text-center">${item.grade}</td><td class="px-4 py-3 text-sm text-center">${label}</td></tr>`;
                        });
                    } else {
                        phoneTableRows = '<tr><td colspan="4" class="px-4 py-4 text-center text-sm text-gray-500">No phones in stock.</td></tr>';
                    }

                    let accessoryTableRows = '';
                    if (summary.accessory_types > 0) {
                        storeData.accessories.sort((a, b) => a.model_name.localeCompare(b.model_name));
                        storeData.accessories.forEach(item => {
                            let label = '';
                            if (item.discontinuation_label) {
                                const labelClass = label_styles[item.discontinuation_label];
                                label = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${labelClass}">${item.discontinuation_label}</span>`;
                            }
                            accessoryTableRows += `<tr class="inventory-table-row" data-item-type="accessory" data-product-id="${item.product_id}"><td class="px-4 py-3 text-sm text-gray-600">${item.model_name}</td><td class="px-4 py-3 text-sm font-medium text-gray-900 text-center">${item.product_id}</td><td class="px-4 py-3 text-sm text-gray-600 text-center">${item.quantity}</td><td class="px-4 py-3 text-sm text-center">${label}</td></tr>`;
                        });
                    } else {
                        accessoryTableRows = '<tr><td colspan="4" class="px-4 py-4 text-center text-sm text-gray-500">No accessories in stock.</td></tr>';
                    }

                    accordionHtml += `<div><h3><button type="button" class="flex items-center justify-between w-full p-4 font-semibold text-left text-gray-800 bg-gray-50 border border-gray-200 hover:bg-gray-100 focus:outline-none" data-accordion-button><span>${storeName} (${summary.phone_units} Phones, ${summary.accessory_types} Accessories)</span><svg class="w-3 h-3 rotate-180 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg></button></h3><div class="hidden border border-t-0 border-gray-200 p-4 space-y-4"><div><h4 class="text-md font-semibold text-gray-700 mb-2">Phone Units</h4><div class="max-h-64 overflow-y-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Model</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Unit ID</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Grade</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Velocity</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${phoneTableRows}</tbody></table></div></div><div><h4 class="text-md font-semibold text-gray-700 mb-2">Accessory Stock</h4><div class="max-h-64 overflow-y-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Accessory Name</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Product ID</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Quantity</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${accessoryTableRows}</tbody></table></div></div></div></div>`;
                }
                accordionContainer.innerHTML = accordionHtml;

            } catch (error) {
                accordionContainer.innerHTML = `<p class="text-red-500">Error loading inventory: ${error.message}</p>`;
            } finally {
                hideLoader('inventory-accordion-loader');
            }
        }

        async function getPhonePriceDetails(unitId) {
            const placeholder = document.getElementById('inventory-results-placeholder');
            const phoneView = document.getElementById('phone-details-view');
            const accessoryView = document.getElementById('accessory-details-view');
            
            showLoader('inventory-loader');
            placeholder.classList.add('hidden');
            phoneView.classList.add('hidden');
            accessoryView.classList.add('hidden');

            try {
                const data = await apiFetch('/inventory/price', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ unit_id: parseInt(unitId) })
                });
                
                phoneView.innerHTML = `<div class="grid grid-cols-2 gap-4"><div><p class="text-sm text-gray-500">Unit ID / Model</p><p class="text-lg font-semibold">${data.unit_id} / ${data.model_name}</p></div><div><p class="text-sm text-gray-500">Days in Inventory</p><p class="text-lg font-semibold">${data.days_in_inventory} days</p></div><div><p class="text-sm text-gray-500">Acquisition Date</p><p class="text-lg font-semibold">${data.acquisition_date}</p></div><div><p class="text-sm text-gray-500">Acquisition Price</p><p class="text-lg font-semibold">$${data.acquisition_price ? data.acquisition_price.toFixed(2) : 'N/A'}</p></div></div><div class="pt-4 border-t mt-4"><p class="text-sm text-gray-500">Recommended Selling Price Range</p><p class="text-lg font-semibold text-indigo-600">$${data.predicted_selling_price_range.low_liquidate_price.toFixed(2)} - $${data.predicted_selling_price_range.high_start_price.toFixed(2)}</p><p class="text-sm text-gray-500">(Fair Market: $${data.predicted_selling_price_range.median_fair_market_price.toFixed(2)})</p></div>`;
                phoneView.classList.remove('hidden');
            } catch (error) {
                phoneView.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                phoneView.classList.remove('hidden');
            } finally {
                hideLoader('inventory-loader');
            }
        }

        async function getAccessoryDetails(productId) {
            const placeholder = document.getElementById('inventory-results-placeholder');
            const phoneView = document.getElementById('phone-details-view');
            const accessoryView = document.getElementById('accessory-details-view');
            
            showLoader('inventory-loader');
            placeholder.classList.add('hidden');
            phoneView.classList.add('hidden');
            accessoryView.classList.add('hidden');

            try {
                const data = await apiFetch(`/accessories/details/${productId}`);
                let compatHtml = data.compatible_phones.map(p => `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${p}</span>`).join('');
                if (!compatHtml) {
                    compatHtml = '<p class="text-sm text-gray-500">No specific compatible phones listed.</p>';
                }

                accessoryView.innerHTML = `<div><p class="text-sm text-gray-500">Accessory Name / ID</p><p class="text-lg font-semibold">${data.model_name} / ${data.product_id}</p></div><div><p class="text-sm text-gray-500">MSRP / Cost</p><p class="text-lg font-semibold">$${data.original_msrp ? data.original_msrp.toFixed(2) : 'N/A'}</p></div><div class="pt-4 border-t mt-4"><p class="text-sm font-medium text-gray-700 mb-2">Compatible Phone Models</p><div>${compatHtml}</div></div>`;
                accessoryView.classList.remove('hidden');
            } catch (error) {
                accessoryView.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                accessoryView.classList.remove('hidden');
            } finally {
                hideLoader('inventory-loader');
            }
        }

        // --- Transaction History Logic ---
        document.getElementById('history-filter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            loadTransactionHistory();
        });

        async function loadTransactionHistory() {
            showLoader('history-loader');
            document.getElementById('history-results-area').classList.add('hidden');
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = '';
            
            const params = new URLSearchParams({
                model_name: document.getElementById('history-model').value,
                grade: document.getElementById('history-grade').value,
                store_id: document.getElementById('history-store').value,
                start_date: document.getElementById('history-start-date').value,
                end_date: document.getElementById('history-end-date').value,
            });

            for(let [key, val] of params.entries()) {
                if (!val) { params.delete(key); }
            }
            
            try {
                const data = await apiFetch(`/transactions/history?${params.toString()}`);
                
                const summary = data.summary;
                document.getElementById('summary-revenue').textContent = summary.total_revenue ? `$${summary.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '$0.00';
                document.getElementById('summary-cost').textContent = summary.total_cost ? `$${summary.total_cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '$0.00';
                document.getElementById('summary-profit').textContent = summary.total_profit ? `$${summary.total_profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '$0.00';
                document.getElementById('summary-items').textContent = summary.total_items_sold || 0;
                document.getElementById('summary-avg-days').textContent = summary.average_days_in_stock ? `${summary.average_days_in_stock.toFixed(1)} (Phones)` : 'N/A';

                let tableHtml = '';
                if(data.transactions && data.transactions.length > 0) {
                     data.transactions.forEach(tx => {
                        const profit = tx.profit_loss === null ? 0 : tx.profit_loss;
                        const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';
                        tableHtml += `<tr><td class="px-4 py-3 text-sm font-medium text-gray-800">${tx.transaction_id}</td><td class="px-4 py-3 text-sm">${tx.transaction_date}</td><td class="px-4 py-3 text-sm">${tx.model_name}</td><td class="px-4 py-3 text-sm text-center">${tx.grade ? tx.grade : 'N/A'}</td><td class="px-4 py-3 text-sm text-right">$${(tx.final_sale_price || 0).toFixed(2)}</td><td class="px-4 py-3 text-sm text-right font-medium ${profitColor}">$${profit.toFixed(2)}</td></tr>`;
                    });
                } else {
                    tableHtml = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No transactions match the current filters.</td></tr>';
                }
                tableBody.innerHTML = tableHtml;

                renderHistoryChart(data.transactions);

                document.getElementById('history-results-area').classList.remove('hidden');
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading data: ${error.message}</td></tr>`;
            } finally {
                hideLoader('history-loader');
            }
        }
        
        function renderHistoryChart(transactions) {
            const monthlyProfit = {};
            if(transactions) {
                 transactions.forEach(tx => {
                    if (tx.profit_loss === null) return;
                    const month = tx.transaction_date.substring(0, 7);
                    if (!monthlyProfit[month]) { monthlyProfit[month] = 0; }
                    monthlyProfit[month] += tx.profit_loss;
                });
            }

            const sortedMonths = Object.keys(monthlyProfit).sort();
            const chartLabels = sortedMonths;
            const chartData = sortedMonths.map(month => monthlyProfit[month]);

            if (historyChartInstance) { historyChartInstance.destroy(); }
            
            const ctx = document.getElementById('history-chart').getContext('2d');
            historyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Total Profit',
                        data: chartData,
                        backgroundColor: chartData.map(v => v >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
                        borderColor: chartData.map(v => v >= 0 ? 'rgb(22, 163, 74)' : 'rgb(220, 38, 38)'),
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => '$' + value } }, }, plugins: { legend: { display: false } } }
            });
        }

        // --- Recommendation Logic ---
        document.getElementById('recommendation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const modelName = document.getElementById('recommendation-model').value;
            if (!modelName) { alert('Please select a Phone Model.'); return; }
            const resultsContainer = document.getElementById('recommendation-results-container');
            const resultsDiv = document.getElementById('recommendation-results');
            
            showLoader('recommendation-loader');
            resultsContainer.classList.remove('hidden');
            resultsDiv.innerHTML = '';

            try {
                const data = await apiFetch('/recommend/accessories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_model_name: modelName })
                });

                if (data.length === 0) {
                     resultsDiv.innerHTML = `<p class="text-gray-500">No recommendations available for this product.</p>`;
                } else {
                    let content = '';
                    data.forEach(item => {
                        content += `<div class="p-3 border rounded-lg"><p class="font-semibold">${item.model_name}</p><p class="text-sm text-gray-500">Product ID: ${item.product_id} | MSRP: $${item.original_msrp ? item.original_msrp.toFixed(2) : 'N/A'}</p></div>`;
                    });
                    resultsDiv.innerHTML = content;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            } finally {
                hideLoader('recommendation-loader');
            }
        });

        // --- Discontinuation Logic ---
        async function loadDiscontinuationList() {
            const listContainer = document.getElementById('discontinuation-list');
            const loader = document.getElementById('discontinuation-loader');
            const tableContainer = document.getElementById('discontinuation-table-container');

            showLoader('discontinuation-loader');
            tableContainer.classList.add('hidden');

            try {
                const data = await apiFetch('/inventory/discontinuation_alerts');
                listContainer.innerHTML = '';
                if (data.length === 0) {
                    listContainer.innerHTML = '<tr><td colspan="3" class="text-center py-4">No discontinuation alerts at this time.</td></tr>';
                } else {
                    data.forEach(item => {
                        listContainer.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.product_id}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.model_name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.compatible_phone_sales_past_180_days}</td></tr>`;
                    });
                }
                tableContainer.classList.remove('hidden');
            } catch (error) {
                listContainer.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading data: ${error.message}</td></tr>`;
            } finally {
                hideLoader('discontinuation-loader');
            }
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.loader').forEach(l => l.parentElement.classList.add('hidden'));

            populatePhoneModels();
            populateStores();
            loadDiscontinuationList();
            updateClock();
            setInterval(updateClock, 1000);
            
            const accordionContainer = document.getElementById('inventory-accordion-container');
            if(accordionContainer) {
                accordionContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('[data-accordion-button]');
                    if (button) {
                        const body = button.parentElement.nextElementSibling;
                        const icon = button.querySelector('svg');
                        body.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                        return;
                    }

                    const row = e.target.closest('.inventory-table-row');
                    if (row) {
                        accordionContainer.querySelectorAll('.inventory-table-row').forEach(r => r.classList.remove('selected'));
                        row.classList.add('selected');

                        const itemType = row.dataset.itemType;
                        if (itemType === 'phone') {
                            getPhonePriceDetails(row.dataset.unitId);
                        } else if (itemType === 'accessory') {
                            getAccessoryDetails(row.dataset.productId);
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>